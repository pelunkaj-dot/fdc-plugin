<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FajnDouƒçko ‚Äì diagnostick√Ω full‚Äëpage chat</title>
  <style>
    :root { --radius: 16px; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, 'Helvetica Neue', Arial; background:#0b0f19; color:#e6e9ef; }
    header { position:sticky; top:0; z-index:10; backdrop-filter: blur(8px); background:rgba(13,17,27,.65); border-bottom:1px solid #202434; }
    .wrap { max-width: 920px; margin: 0 auto; padding: 12px 16px; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    select, button, input { border-radius: var(--radius); border:1px solid #2a3146; background:#121726; color:#e6e9ef; }
    button { padding:10px 14px; cursor:pointer; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    select, input { padding:10px 12px; }
    main { height: calc(100dvh - 180px); overflow:auto; padding: 16px; }
    .card { background:#101522; border:1px solid #1e2435; border-radius: var(--radius); padding:14px; }
    .log { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', monospace; white-space: pre-wrap; word-break: break-word; }
    .msgs { display:flex; flex-direction:column; gap:10px; }
    .msg { padding:12px 14px; border-radius: 14px; max-width: 78ch; width: fit-content; }
    .u { background:#1a243a; align-self:flex-end; border:1px solid #2a3657; }
    .a { background:#121a2b; align-self:flex-start; border:1px solid #202a46; }
    footer { position:sticky; bottom:0; border-top:1px solid #202434; background:#0b0f19; padding:10px 16px; }
    .inputRow { display:flex; gap:10px; }
    .inputRow textarea { flex:1; resize: vertical; min-height: 48px; max-height: 40dvh; border-radius: var(--radius); border:1px solid #2a3146; background:#0f1524; color:#e6e9ef; padding:12px; line-height:1.35; }
    .pill { display:inline-flex; align-items:center; gap:8px; border:1px solid #2a3146; background:#11182a; padding:8px 10px; border-radius:999px; font-size:.9rem; }
    .ok { color:#6de38d; }
    .bad { color:#ff8a8a; }
    .muted { color:#9aa7bd; font-size:.92rem; }
    details { background:#0f1524; border:1px solid #1f2740; border-radius: 10px; padding:10px 12px; }
    summary { cursor:pointer; }
    /* High‚Äëcontrast / svƒõtl√Ω re≈æim */
    body.hc { background:#ffffff; color:#111827; }
    body.hc header { background:#ffffffcc; border-bottom:1px solid #cdd3df; }
    body.hc .card { background:#ffffff; border:1px solid #cdd3df; }
    body.hc .muted { color:#475569; }
    body.hc .pill { background:#ffffff; border:1px solid #9aa7bd; }
    body.hc .ok { color:#15803d; }
    body.hc .bad { color:#b91c1c; }
    body.hc select, body.hc button, body.hc input, body.hc textarea { background:#ffffff; color:#111827; border:1px solid #9aa7bd; }
    body.hc .msg.u { background:#e9f0ff; border:1px solid #b6c6ff; color:#0f172a; }
    body.hc .msg.a { background:#f5f7fb; border:1px solid #cdd3df; color:#0f172a; }
  </style>
</head>
<body>
  <header>
    <div class="wrap row">
      <strong>FajnDouƒçko ‚Äì full‚Äëpage chat (diagnostika)</strong>
      <button id="btn-contrast" class="pill" title="P≈ôepnout kontrast">‚òÄÔ∏è Kontrast</button>
      <span id="ping" class="pill muted">Neotestov√°no</span>
      <div class="row" style="margin-left:auto; gap:8px;">
        <label class="muted">Asistent</label>
        <select id="assistant"></select>
        <button id="refresh">Znovu naƒç√≠st</button>
      </div>
    </div>
  </header>

  <main>
    <div class="wrap" style="display:grid; gap:14px;">
      <div class="card">
        <div class="muted" style="margin-bottom:8px;">Diagnostika</div>
        <div class="row" style="gap:8px; flex-wrap:wrap;">
          <button id="btn-selftest">Ping /api/self-test</button>
          <button id="btn-assistants">Naƒç√≠st /api/assistants</button>
          <button id="btn-clear">Vyƒçistit konverzaci</button>
        </div>
        <details style="margin-top:10px;">
          <summary>Protokol</summary>
          <pre class="log" id="log"></pre>
        </details>
      </div>

      <div class="card msgs" id="msgs" aria-live="polite"></div>
    </div>
  </main>

  <footer>
    <div class="wrap">
      <div class="inputRow">
        <textarea id="input" placeholder="Napi≈° zpr√°vu‚Ä¶ (Shift+Enter = nov√Ω ≈ô√°dek)" ></textarea>
        <button id="send">Odeslat</button>
      </div>
      <div class="muted" style="margin-top:6px;">Gateway: <code id="gwText"></code></div>
    </div>
  </footer>

  <script>
    // ‚öôÔ∏è Nastav si p≈ô√≠padnƒõ vlastn√≠ dom√©nu gatewaye (kdy≈æ ji p≈ôesune≈° z Vercelu)
    const GATEWAY = 'https://fdc-gateway.vercel.app';
    const PATHS = {
      selfTest: '/api/self-test',
      assistants: '/api/assistants',
      chat: '/api/chat'
    };

    // üí° Pomocn√© UI
    const $ = (s) => document.querySelector(s);
    const log = (x) => { const t = new Date().toLocaleTimeString(); $('#log').textContent += `\n[${t}] ${x}`; };
    const setPing = (ok, txt) => {
      const el = $('#ping');
      el.className = 'pill ' + (ok ? 'ok' : 'bad');
      el.textContent = txt;
    };
    const addMsg = (role, text) => {
      const wrap = document.createElement('div');
      wrap.className = 'msg ' + (role === 'user' ? 'u' : 'a');
      wrap.textContent = text;
      $('#msgs').appendChild(wrap);
      // Autoscroll na konec
      const main = document.querySelector('main');
      main.scrollTop = main.scrollHeight + 9999;
    };

    $('#gwText').textContent = GATEWAY;

    // üß™ Self‚Äëtest
    async function doSelfTest(){
      try {
        const r = await fetch(GATEWAY + PATHS.selfTest);
        const txt = await r.text();
        const ok = r.ok;
        setPing(ok, ok ? 'Gateway OK' : 'Gateway chyba');
        log(`/api/self-test ‚Üí ${r.status} ${ok ? 'OK' : 'ERR'}\n` + txt);
      } catch (e) {
        setPing(false, 'Gateway nedostupn√°');
        log('Self-test ERR: ' + e.message);
      }
    }

    // üë• Naƒçten√≠ asistent≈Ø
    async function loadAssistants(){
      const sel = $('#assistant');
      sel.innerHTML = '';
      try {
        const r = await fetch(GATEWAY + PATHS.assistants);
        const data = await r.json();
        log(`/api/assistants ‚Üí ${r.status}`);
        const list = Array.isArray(data) ? data : (Array.isArray(data.assistants) ? data.assistants : []);
        if (!list.length) log('Varov√°n√≠: pr√°zdn√Ω seznam asistent≈Ø');
        for (const a of list){
          const opt = document.createElement('option');
          // podporujeme kl√≠ƒçe "slug" | "id" | string
          const val = typeof a === 'string' ? a : (a.slug || a.id || a.name || 'assistant');
          opt.value = val;
          opt.textContent = typeof a === 'string' ? a : (a.label || a.name || a.slug || val);
          sel.appendChild(opt);
        }
        if (!sel.value) {
          const opt = document.createElement('option');
          opt.value = 'amy'; opt.textContent = 'amy (fallback)'; sel.appendChild(opt);
        }
      } catch (e) {
        log('Chyba naƒç√≠t√°n√≠ /assistants: ' + e.message + ' (doplnƒõn fallback amy)');
        const opt = document.createElement('option');
        opt.value = 'amy'; opt.textContent = 'amy (fallback)'; sel.appendChild(opt);
      }
    }

    // üí¨ Odesl√°n√≠ zpr√°vy
    async function sendMessage(){
      const ta = $('#input');
      const text = ta.value.trim();
      if (!text) return;
      addMsg('user', text);
      ta.value = '';
      $('#send').disabled = true;

      // üì¶ Konzervativn√≠ payload kompatibiln√≠ s vƒõt≈°inou jednoduch√Ωch gateway√≠.
      // Pokud tv≈Øj /api/chat oƒçek√°v√° jin√Ω form√°t, uvid√≠≈° to v logu (400 + text odpovƒõdi) ‚Äì staƒç√≠ pak upravit body.
      const body = {
        assistant: $('#assistant').value || 'amy',
        messages: [{ role: 'user', content: text }]
      };

      try {
        const r = await fetch(GATEWAY + PATHS.chat, {
          method: 'POST',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify(body)
        });

        const ct = r.headers.get('content-type') || '';
        let dataText = '';
        if (ct.includes('application/json')) {
          const data = await r.json();
          // pokus√≠me se naj√≠t text odpovƒõdi v obvykl√Ωch pol√≠ch
          const reply = (data.reply || data.output || data.message || data.content || data.text || '');
          addMsg('assistant', String(reply || '[≈Ω√°dn√° odpovƒõƒè v JSON]'));
          dataText = JSON.stringify(data, null, 2);
        } else {
          const txt = await r.text();
          addMsg('assistant', (r.ok ? txt : `[${r.status}] ${txt}`));
          dataText = txt;
        }
        log(`/api/chat ‚Üí ${r.status}\n` + dataText);
      } catch (e) {
        addMsg('assistant', '‚ö†Ô∏è Chyba s√≠tƒõ: ' + e.message);
        log('sendMessage ERR: ' + e.message);
      } finally {
        $('#send').disabled = false;
      }
    }

    // üßΩ ƒåi≈°tƒõn√≠ obrazovky
    function clearChat(){
      $('#msgs').innerHTML='';
      $('#log').textContent='';
    }

    // ‚å®Ô∏è Kl√°vesov√© zkratky
    $('#input').addEventListener('keydown', (ev)=>{
      if (ev.key === 'Enter' && !ev.shiftKey) { ev.preventDefault(); sendMessage(); }
    });

    // üîò Tlaƒç√≠tka
    $('#btn-selftest').onclick = doSelfTest;
    $('#btn-assistants').onclick = loadAssistants;
    $('#btn-clear').onclick = clearChat;
    $('#refresh').onclick = async ()=>{ await doSelfTest(); await loadAssistants(); };
    $('#send').onclick = sendMessage;
    const contrastBtn = document.querySelector('#btn-contrast');
    if (contrastBtn) contrastBtn.onclick = ()=> document.body.classList.toggle('hc');

    // üöÄ Start: hned p√≠pnu gateway a naƒçtu asistenty
    (async ()=>{ await doSelfTest(); await loadAssistants(); })();
  </script>
</body>
</html>
